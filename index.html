<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hawk Space — 登录</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --accent1:#00eaff;
    --accent2:#ffd400;
    --bg:#000000;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, "Microsoft YaHei", sans-serif;color:#fff;overflow:hidden}
  /* canvas 背景满屏 */
  canvas#bg {position:fixed; inset:0; z-index:0; display:block}

  /* 登录面板 */
  .panel {
    position:relative;
    z-index:3;
    width:380px;
    margin:0 auto;
    top:50%;
    transform:translateY(-50%);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:14px;
    padding:28px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.8), 0 0 50px rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    border:1px solid rgba(255,255,255,0.03);
  }

  .panel .title {text-align:center; font-family: 'Orbitron', sans-serif; font-size:22px; color:var(--accent2); text-shadow:0 0 20px rgba(255,212,0,0.15)}
  .panel .desc {text-align:center; color:#bdbdbd; margin-top:8px; font-size:13px}

  .form {margin-top:18px}
  .form input {
    width:100%; padding:12px 14px; margin:10px 0; border-radius:10px;
    border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03); color:#fff;
    outline:none; font-size:14px; transition:box-shadow .18s, border-color .18s;
  }
  .form input:focus {box-shadow:0 0 12px rgba(0,234,255,0.08); border-color:rgba(0,234,255,0.25)}

  .row {display:flex; gap:10px}
  .btn {
    width:100%; padding:12px; border-radius:10px; border:none; cursor:pointer;
    background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#07121b;
    font-weight:700; box-shadow: 0 6px 18px rgba(0,234,255,0.08);
    position:relative; overflow:hidden;
  }
  .btn:active{transform:scale(.995)}
  .small {font-size:13px; padding:8px 10px}

  .links {margin-top:12px; text-align:center; color:#bdbdbd; font-size:13px}
  .links a {color:var(--accent1); text-decoration:none; margin:0 6px}

  /* 点击扩散特效 */
  .ripple {
    position:fixed; pointer-events:none; border-radius:50%;
    transform:translate(-50%,-50%) scale(1);
    background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0.2));
    opacity:0.9; z-index:1000; animation:rippleA .8s ease-out forwards;
  }
  @keyframes rippleA {to{transform:translate(-50%,-50%) scale(12); opacity:0}}

  /* 管理面板浮层（登录后出现） */
  .admin-panel {
    position:fixed; right:20px; top:20px; z-index:4; width:520px; max-height:78vh; overflow:auto;
    background:rgba(10,10,10,0.85); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.04);
    box-shadow:0 8px 30px rgba(0,0,0,0.7);
    color:#e6e6e6; font-size:13px;
  }
  .admin-panel h3 {margin:6px 0 8px 0; color:var(--accent1)}
  .log {padding:8px; border-bottom:1px solid rgba(255,255,255,0.03)}
  .log .meta {color:#bdbdbd; font-size:12px; margin-top:6px}
  .hidden{display:none}
  /* 响应 */
  @media (max-width:480px){
    .panel{width:92%; padding:18px}
    .admin-panel{width:92%; left:4%; right:4%; top:auto; bottom:12px; max-height:36vh}
  }
</style>
</head>
<body>

<canvas id="bg"></canvas>

<!-- 登录面板 -->
<div class="panel" id="mainPanel">
  <div class="title">Hawk Space</div>
  <div class="desc">霓虹星域 · 邮箱登录 / 注册 · 可跨设备登录</div>

  <div class="form">
    <input id="email" type="email" placeholder="邮箱 (例如：you@example.com)">
    <input id="password" type="password" placeholder="密码（6位或以上）">
    <div style="height:12px"></div>
    <button class="btn" id="loginBtn">登录</button>
    <div style="height:10px"></div>
    <button class="btn small" id="registerBtn" style="background:linear-gradient(90deg,var(--accent2),var(--accent1));">注册</button>
    <div class="links">
      其他登录： <a href="#" id="githubBtn">GitHub</a> · <a href="#" id="qqBtn">QQ</a> · <a href="#" id="wxBtn">微信</a>
    </div>

    <div id="message" style="margin-top:12px;color:#ffcc66;font-size:13px"></div>
  </div>
</div>

<!-- 管理员面板（默认隐藏） -->
<div id="adminPanel" class="admin-panel hidden" aria-hidden="true">
  <h3>管理员 — 登录日志</h3>
  <div id="logsContainer">加载中…</div>
  <div style="text-align:right; margin-top:8px">
    <button id="logoutBtn" class="small" style="background:rgba(255,255,255,0.05); border-radius:6px; color:#fff; padding:6px 10px">登出</button>
  </div>
</div>

<!-- 引入 Firebase CDN (模块方式) -->
<script type="module">
  // ---------------------------
  // 请不要修改以下 firebaseConfig（已经为你配置）
  // ---------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signInWithPopup,
    GithubAuthProvider,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    getDocs,
    setDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // ====== Firebase 配置 ======
  const firebaseConfig = {
    apiKey: "AIzaSyADOCcNc25GUmDNKiHGZxLnFcUjaq1tlOo",
    authDomain: "hawk-e6b7b.firebaseapp.com",
    projectId: "hawk-e6b7b",
    storageBucket: "hawk-e6b7b.firebasestorage.app",
    messagingSenderId: "569058504244",
    appId: "1:569058504244:web:485093c03906bd05c6a461"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 管理员 UID 列表（把你的管理员 uid 放进来，多个逗号分隔）
  // 运行前你可以把 ADMIN_UIDS 写成实际 uid 字符串，如: ['abcUID123']
  const ADMIN_UIDS = ['']; // <-- 开发时把管理员 UID 放到这里（注册后复制到此数组）

  // DOM 元素
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const messageEl = document.getElementById('message');
  const adminPanel = document.getElementById('adminPanel');
  const logsContainer = document.getElementById('logsContainer');
  const logoutBtn = document.getElementById('logoutBtn');

  // 工具：显示短消息
  function showMsg(text, isError=false){
    messageEl.textContent = text;
    messageEl.style.color = isError ? '#ff6b6b' : '#ffcc66';
    setTimeout(()=>{ messageEl.textContent = ''; }, 4000);
  }

  // 获取公网 IP（免费服务 ipify）
  async function fetchPublicIP(){
    try {
      const r = await fetch('https://api.ipify.org?format=json');
      if(!r.ok) return null;
      const j = await r.json();
      return j.ip || null;
    } catch(e){ return null; }
  }

  // 获取浏览器经纬（需要用户同意）
  function getGeo(timeout=3000){
    return new Promise(res=>{
      if(!navigator.geolocation) return res(null);
      const tid = setTimeout(()=>res(null), timeout);
      navigator.geolocation.getCurrentPosition(pos=>{
        clearTimeout(tid);
        res({lat: pos.coords.latitude, lon: pos.coords.longitude});
      }, ()=>{ clearTimeout(tid); res(null); }, {enableHighAccuracy:false, timeout});
    });
  }

  // 写入登录日志到 Firestore
  async function writeLoginLog(uid, email, type='login'){
    try {
      const ip = await fetchPublicIP();
      const loc = await getGeo(3000);
      const ua = navigator.userAgent || 'unknown';
      await addDoc(collection(db, 'login_logs'), {
        uid, email, type, ts: serverTimestamp(), ua, ip, loc
      });
    } catch(e){
      console.warn('写入登录日志失败', e);
    }
  }

  // 注册（邮箱+密码）
  registerBtn.addEventListener('click', async ()=>{
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email || !pass){ showMsg('请填写邮箱和密码', true); return; }
    if(pass.length < 6){ showMsg('密码至少 6 位', true); return; }
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      // 创建用户资料文档（不存密码）
      await setDoc(doc(db, 'users', cred.user.uid), { email, createdAt: serverTimestamp() });
      await writeLoginLog(cred.user.uid, email, 'register');
      showMsg('注册成功，已登录（自动）');
    } catch(err){
      // 常见错误：auth/email-already-in-use、auth/invalid-email
      showMsg(err.message || '注册失败', true);
    }
  });

  // 登录（邮箱+密码）
  loginBtn.addEventListener('click', async ()=>{
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email || !pass){ showMsg('请填写邮箱和密码', true); return; }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      const user = auth.currentUser;
      // 写登录日志
      await writeLoginLog(user.uid, user.email, 'login');
      showMsg('登录成功，正在跳转...');
      setTimeout(()=>{ window.location.href = 'home.html'; }, 800);
    } catch(err){
      // 如果用户不存在，Firebase 返回 auth/user-not-found
      if(/user-not-found|找不到/i.test(err.message || '')) {
        showMsg('请先注册', true);
      } else {
        showMsg(err.message || '登录失败', true);
      }
    }
  });

  // GitHub 登录（示例：需要在 Firebase 控制台启用 GitHub provider 并设置 Client ID/Secret）
  document.getElementById('githubBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    const provider = new GithubAuthProvider();
    try {
      const res = await signInWithPopup(auth, provider);
      const u = res.user;
      // 创建/更新用户文档（不存密码）
      await setDoc(doc(db, 'users', u.uid), { email: u.email || null, name: u.displayName || null, provider:'github', createdAt: serverTimestamp() }, { merge: true });
      await writeLoginLog(u.uid, u.email || null, 'oauth_github');
      showMsg('GitHub 登录成功，正在跳转...');
      setTimeout(()=> window.location.href='home.html', 800);
    } catch(err){ showMsg(err.message || 'GitHub 登录失败', true); }
  });

  // 监听登录状态，若管理员登录则显示日志
  onAuthStateChanged(auth, async user=>{
    if(user && ADMIN_UIDS.includes(user.uid)){
      adminPanel.classList.remove('hidden');
      adminPanel.setAttribute('aria-hidden','false');
      // 取最近 100 条日志（按时间降序）
      try {
        const q = query(collection(db,'login_logs'), orderBy('ts','desc'));
        const snap = await getDocs(q);
        logsContainer.innerHTML = '';
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const ts = d.ts && d.ts.toDate ? d.ts.toDate().toLocaleString() : (d.ts? String(d.ts) : '—');
          const loc = d.loc ? `${d.loc.lat.toFixed(4)}, ${d.loc.lon.toFixed(4)}` : '—';
          const ip = d.ip || '—';
          const email = d.email || '—';
          const ua = d.ua || '—';
          const uid = d.uid || '—';
          const type = d.type || '—';
          const node = document.createElement('div');
          node.className = 'log';
          node.innerHTML = `<div><strong>${email}</strong> <span style="color:#9aa9ff">[${type}]</span></div>
            <div class="meta">UID: ${uid} · 时间: ${ts} · IP: ${ip} · 位置信息: ${loc}</div>
            <div class="meta">设备/UA: ${ua}</div>`;
          logsContainer.appendChild(node);
        });
      } catch(e){ logsContainer.innerText = '读取日志失败：'+String(e); }
    } else {
      adminPanel.classList.add('hidden');
      adminPanel.setAttribute('aria-hidden','true');
    }
  });

  // 管理员登出按钮
  logoutBtn.addEventListener('click', async ()=>{
    try { await signOut(auth); showMsg('已登出'); } catch(e){ showMsg('登出失败', true); }
  });
</script>

<!-- 粒子 + 流星 背景脚本 (canvas) -->
<script>
  // canvas 粒子系统：密集粒子 + 偶发流星
  const canvas = document.getElementById('bg');
  const ctx = canvas.getContext('2d');
  let W = canvas.width = innerWidth;
  let H = canvas.height = innerHeight;

  window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; initParticles(); });

  // particles array
  let particles = [];
  const PARTICLE_COUNT = Math.floor((W*H)/7000); // 根据屏幕适配数量
  function initParticles(){
    particles = [];
    const count = Math.max(80, Math.min(500, Math.floor((W*H)/6000)));
    for(let i=0;i<count;i++){
      particles.push({
        x: Math.random()*W,
        y: Math.random()*H,
        r: Math.random()*1.5 + 0.6,
        vx: (Math.random()-0.5) * 0.3,
        vy: (Math.random()-0.5) * 0.3,
        alpha: 0.2 + Math.random()*0.6,
        hue: (Math.random()*30)+190 // 主色偏青蓝
      });
    }
  }
  initParticles();

  // meteors
  let meteors = [];
  function spawnMeteor(){
    meteors.push({
      x: Math.random()*W*1.2,
      y: Math.random()*H*0.3,
      vx: -6 - Math.random()*6,
      vy: 3 + Math.random()*3,
      len: 80 + Math.random()*180,
      life: 0
    });
  }

  let t=0;
  function loop(){
    t++;
    ctx.fillStyle = 'rgba(0,0,0,0.18)';
    ctx.fillRect(0,0,W,H);

    // draw particles
    for(let p of particles){
      p.x += p.vx; p.y += p.vy;
      if(p.x < -20) p.x = W+20;
      if(p.x > W+20) p.x = -20;
      if(p.y < -20) p.y = H+20;
      if(p.y > H+20) p.y = -20;
      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue},80%,60%,${p.alpha})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }

    // occasional connections glow (soft)
    for(let i=0;i<20;i++){
      const a = particles[Math.floor(Math.random()*particles.length)];
      const b = particles[Math.floor(Math.random()*particles.length)];
      if(!a || !b) continue;
      const dx = a.x-b.x, dy=a.y-b.y;
      const d2 = dx*dx + dy*dy;
      if(d2 < 40000){
        ctx.beginPath();
        ctx.strokeStyle = `rgba(0,234,255,${0.01 + Math.random()*0.02})`;
        ctx.lineWidth = 0.6;
        ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      }
    }

    // spawn meteor sometimes
    if(Math.random() < 0.02) spawnMeteor();

    for(let i=meteors.length-1;i>=0;i--){
      const m = meteors[i];
      m.x += m.vx; m.y += m.vy; m.life++;
      ctx.save();
      ctx.globalAlpha = Math.max(0, 1 - m.life/120);
      const g = ctx.createLinearGradient(m.x,m.y,m.x - m.len, m.y - m.len);
      g.addColorStop(0, "rgba(255,255,255,1)");
      g.addColorStop(1, "rgba(0,234,255,0)");
      ctx.strokeStyle = g;
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x - m.len, m.y - m.len); ctx.stroke();
      ctx.restore();
      if(m.x < -100 || m.y > H+100 || m.life>200) meteors.splice(i,1);
    }

    requestAnimationFrame(loop);
  }
  loop();

  // 点击页面生成粒子光圈（保持你喜欢的点击效果）
  document.addEventListener('click', function(e){
    const el = document.createElement('div');
    el.className = 'ripple';
    el.style.left = e.clientX + 'px';
    el.style.top = e.clientY + 'px';
    el.style.width = '14px'; el.style.height = '14px';
    el.style.background = 'radial-gradient(circle, rgba(255,255,255,0.9), rgba(0,234,255,0.15))';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 800);
    // 同时在 canvas 上发射一些小粒子
    for(let i=0;i<16;i++){
      particles.push({
        x: e.clientX + (Math.random()-0.5)*30,
        y: e.clientY + (Math.random()-0.5)*30,
        r: Math.random()*2+0.4,
        vx: (Math.random()-0.5)*2,
        vy: (Math.random()-0.5)*2,
        alpha: 0.6 + Math.random()*0.4,
        hue: 195 + Math.random()*60
      });
    }
  });
</script>
</body>
</html>
